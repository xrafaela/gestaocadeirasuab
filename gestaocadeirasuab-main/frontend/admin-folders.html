<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - Sincroniza√ß√£o de Pastas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover {
            background: #00a884;
        }

        .btn-secondary {
            background: #636e72;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5458;
        }

        .mappings-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .mapping-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .mapping-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .mapping-item h3 {
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .mapping-item .path {
            color: #666;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            background: white;
            padding: 5px;
            border-radius: 5px;
            margin: 8px 0;
            word-break: break-all;
        }

        .mapping-item .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .mapping-item .stats span {
            color: #666;
            font-size: 0.9rem;
        }

        .mapping-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .mapping-actions button {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #333;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .suggestions {
            margin-top: 20px;
        }

        .suggestion-item {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item .info {
            flex: 1;
        }

        .suggestion-item .name {
            font-weight: bold;
            color: #333;
        }

        .suggestion-item .path {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .files-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .name {
            font-weight: 600;
            color: #333;
        }

        .file-item .meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffe4e4;
            border: 2px solid #ff4757;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #e4ffe4;
            border: 2px solid #00b894;
            color: #00695c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #333;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #636e72;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #4a5458;
            transform: translateX(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">‚Üê Voltar ao Sistema</a>
        
        <div class="header">
            <h1>üóÇÔ∏è Administra√ß√£o de Sincroniza√ß√£o de Pastas</h1>
            <p>Configure as pastas das disciplinas para sincroniza√ß√£o autom√°tica de arquivos</p>
        </div>

        <div id="alertContainer"></div>

        <div class="main-content">
            <!-- Adicionar Novo Mapeamento -->
            <div class="card">
                <h2>üìÅ Adicionar Mapeamento</h2>
                
                <form id="mappingForm">
                    <div class="form-group">
                        <label for="disciplinaSelect">Disciplina:</label>
                        <select id="disciplinaSelect" required>
                            <option value="">Selecione uma disciplina...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="folderPath">Caminho da Pasta:</label>
                        <input type="text" id="folderPath" placeholder="/home/usuario/Documentos/Disciplina" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        ‚ûï Adicionar Mapeamento
                    </button>
                </form>

                <div class="suggestions" id="suggestions">
                    <h3>üí° Sugest√µes Autom√°ticas</h3>
                    <div id="suggestionsList" class="loading">Procurando pastas...</div>
                </div>
            </div>

            <!-- Lista de Mapeamentos -->
            <div class="card">
                <h2>üìã Mapeamentos Ativos</h2>
                <div class="mappings-list" id="mappingsList">
                    <div class="loading">Carregando mapeamentos...</div>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="card" style="margin-top: 30px;">
            <h2>üìä Estat√≠sticas Gerais</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h4>Disciplinas</h4>
                    <div class="value" id="totalDisciplinas">0</div>
                </div>
                <div class="stat-card">
                    <h4>Arquivos</h4>
                    <div class="value" id="totalArquivos">0</div>
                </div>
                <div class="stat-card">
                    <h4>Tamanho Total</h4>
                    <div class="value" id="tamanhoTotal">0 MB</div>
                </div>
                <div class="stat-card">
                    <h4>√öltima Sync</h4>
                    <div class="value" id="ultimaSync">--:--</div>
                </div>
            </div>
        </div>

        <!-- Modal de Arquivos -->
        <div id="filesModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeFilesModal()">&times;</span>
                <div class="modal-header">
                    <h2>üìÑ Arquivos da Disciplina</h2>
                </div>
                <div class="files-list" id="filesList">
                    <div class="loading">Carregando arquivos...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let disciplinas = [];

        // Carregar disciplinas ao iniciar
        async function loadDisciplinas() {
            try {
                const response = await fetch(`${API_URL}/disciplinas`);
                disciplinas = await response.json();
                
                const select = document.getElementById('disciplinaSelect');
                select.innerHTML = '<option value="">Selecione uma disciplina...</option>';
                
                disciplinas.forEach(disc => {
                    const option = document.createElement('option');
                    option.value = disc.id;
                    option.textContent = `${disc.nome} (${disc.sigla})`;
                    option.dataset.nome = disc.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar disciplinas:', error);
            }
        }

        // Carregar mapeamentos existentes
        async function loadMappings() {
            try {
                const response = await fetch(`${API_URL}/folders/mappings`);
                const data = await response.json();
                
                if (data.success) {
                    displayMappings(data.mappings);
                }
            } catch (error) {
                console.error('Erro ao carregar mapeamentos:', error);
                showAlert('Erro ao carregar mapeamentos', 'error');
            }
        }

        // Exibir mapeamentos
        function displayMappings(mappings) {
            const container = document.getElementById('mappingsList');
            
            if (mappings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum mapeamento configurado</p>';
                return;
            }
            
            container.innerHTML = mappings.map(mapping => `
                <div class="mapping-item">
                    <h3>${mapping.disciplina_nome}</h3>
                    <div class="path">${mapping.caminho_pasta}</div>
                    <div class="stats">
                        <span>üìÑ ${mapping.total_arquivos || 0} arquivos</span>
                        <span>üíæ ${formatFileSize(mapping.tamanho_total || 0)}</span>
                    </div>
                    <div class="mapping-actions">
                        <button class="btn btn-success" onclick="scanFolder('${mapping.disciplina_id}')">
                            üîÑ Escanear
                        </button>
                        <button class="btn btn-secondary" onclick="viewFiles('${mapping.disciplina_id}', '${mapping.disciplina_nome}')">
                            üëÅÔ∏è Ver Arquivos
                        </button>
                        <button class="btn btn-danger" onclick="removeMapping('${mapping.disciplina_id}')">
                            üóëÔ∏è Remover
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Adicionar novo mapeamento
        document.getElementById('mappingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const select = document.getElementById('disciplinaSelect');
            const disciplinaId = select.value;
            const disciplinaNome = select.options[select.selectedIndex].dataset.nome;
            const folderPath = document.getElementById('folderPath').value;
            
            if (!disciplinaId || !folderPath) {
                showAlert('Por favor, preencha todos os campos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/folders/mappings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        disciplina_id: disciplinaId,
                        disciplina_nome: disciplinaNome,
                        folder_path: folderPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Mapeamento adicionado com sucesso!', 'success');
                    document.getElementById('mappingForm').reset();
                    loadMappings();
                    loadStats();
                } else {
                    showAlert(data.error || 'Erro ao adicionar mapeamento', 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar mapeamento:', error);
                showAlert('Erro ao adicionar mapeamento', 'error');
            }
        });

        // Remover mapeamento
        async function removeMapping(disciplinaId) {
            if (!confirm('Tem certeza que deseja remover este mapeamento?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/folders/mappings/${disciplinaId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Mapeamento removido com sucesso!', 'success');
                    loadMappings();
                    loadStats();
                } else {
                    showAlert(data.error || 'Erro ao remover mapeamento', 'error');
                }
            } catch (error) {
                console.error('Erro ao remover mapeamento:', error);
                showAlert('Erro ao remover mapeamento', 'error');
            }
        }

        // Escanear pasta
        async function scanFolder(disciplinaId) {
            try {
                showAlert('Escaneando pasta...', 'success');
                
                const response = await fetch(`${API_URL}/folders/scan/${disciplinaId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`${data.files_indexed} arquivos indexados!`, 'success');
                    loadMappings();
                    loadStats();
                } else {
                    showAlert(data.error || 'Erro ao escanear pasta', 'error');
                }
            } catch (error) {
                console.error('Erro ao escanear pasta:', error);
                showAlert('Erro ao escanear pasta', 'error');
            }
        }

        // Ver arquivos
        async function viewFiles(disciplinaId, disciplinaNome) {
            const modal = document.getElementById('filesModal');
            const filesList = document.getElementById('filesList');
            
            modal.classList.add('active');
            filesList.innerHTML = '<div class="loading">Carregando arquivos...</div>';
            
            try {
                const response = await fetch(`${API_URL}/folders/files/${disciplinaId}`);
                const data = await response.json();
                
                if (data.success && data.files) {
                    if (data.files.length === 0) {
                        filesList.innerHTML = '<p style="text-align: center; color: #666;">Nenhum arquivo encontrado</p>';
                    } else {
                        filesList.innerHTML = data.files.map(file => `
                            <div class="file-item">
                                <div>
                                    <div class="name">${file.nome_arquivo}</div>
                                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                                        ${file.caminho_relativo || ''}
                                    </div>
                                </div>
                                <div class="meta">
                                    <span>${file.tipo || 'N/A'}</span>
                                    <span>${formatFileSize(file.tamanho || 0)}</span>
                                    <span>${formatDate(file.data_modificacao)}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar arquivos:', error);
                filesList.innerHTML = '<p style="color: red;">Erro ao carregar arquivos</p>';
            }
        }

        // Fechar modal
        function closeFilesModal() {
            document.getElementById('filesModal').classList.remove('active');
        }

        // Carregar sugest√µes
        async function loadSuggestions() {
            try {
                const response = await fetch(`${API_URL}/folders/suggest`);
                const data = await response.json();
                
                if (data.success && data.suggestions) {
                    const container = document.getElementById('suggestionsList');
                    
                    if (data.suggestions.length === 0) {
                        container.innerHTML = '<p style="color: #666;">Nenhuma sugest√£o encontrada</p>';
                    } else {
                        container.innerHTML = data.suggestions.map(sugg => `
                            <div class="suggestion-item">
                                <div class="info">
                                    <div class="name">${sugg.disciplina_nome}</div>
                                    <div class="path">${sugg.folder_path}</div>
                                </div>
                                <button class="btn btn-primary" onclick="applySuggestion('${sugg.disciplina_id}', '${sugg.disciplina_nome}', '${sugg.folder_path}')">
                                    Usar
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar sugest√µes:', error);
            }
        }

        // Aplicar sugest√£o
        function applySuggestion(disciplinaId, disciplinaNome, folderPath) {
            // Encontrar a disciplina correspondente
            const disc = disciplinas.find(d => d.id === disciplinaId);
            if (disc) {
                document.getElementById('disciplinaSelect').value = disc.id;
            }
            document.getElementById('folderPath').value = folderPath;
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/folders/stats`);
                const data = await response.json();
                
                if (data.success && data.stats) {
                    document.getElementById('totalDisciplinas').textContent = data.stats.total_disciplinas || 0;
                    document.getElementById('totalArquivos').textContent = data.stats.total_arquivos || 0;
                    document.getElementById('tamanhoTotal').textContent = formatFileSize(data.stats.tamanho_total || 0);
                    document.getElementById('ultimaSync').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Formatar tamanho de arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Mostrar alerta
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = type;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            loadDisciplinas();
            loadMappings();
            loadSuggestions();
            loadStats();
            
            // Atualizar estat√≠sticas a cada 30 segundos
            setInterval(loadStats, 30000);
        });

        // Fechar modal ao clicar fora
        document.getElementById('filesModal').addEventListener('click', (e) => {
            if (e.target.id === 'filesModal') {
                closeFilesModal();
            }
        });
    </script>
</body>
</html>